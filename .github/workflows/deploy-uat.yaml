name: Deploy to UAT

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy-uat:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch secrets from Discovery Service
        id: fetch-secrets
        run: |
          # Fetch all configs from Discovery Service
          RESPONSE=$(curl -s -H "Authorization: Bearer 229db44b-2bd1-4fc3-884d-815fad0f6824" \
            https://services.prasuti.ai/api/configs)
          
          # Extract GH_PAT
          GH_PAT=$(echo "$RESPONSE" | jq -r '.[] | select(.key == "GH_PAT") | .value')
          echo "::add-mask::$GH_PAT"
          echo "GH_PAT=$GH_PAT" >> $GITHUB_ENV
          
          # Extract KUBECONFIG and save to file
          KUBECONFIG_CONTENT=$(echo "$RESPONSE" | jq -r '.[] | select(.key == "KUBECONFIG") | .value')
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "KUBECONFIG_PATH=$HOME/.kube/config" >> $GITHUB_ENV
          
          echo "âœ… Secrets fetched from Discovery Service"
      
      - name: Checkout Prasuti-KubeNet
        uses: actions/checkout@v4
        with:
          path: Prasuti-KubeNet
      
      - name: Checkout Prasuti-Services
        uses: actions/checkout@v4
        with:
          repository: PrasutiAI/Prasuti-Services
          path: Prasuti-Services
          token: ${{ env.GH_PAT }}
      
      - name: Checkout Prasuti-Accounts
        uses: actions/checkout@v4
        with:
          repository: PrasutiAI/Prasuti-Accounts
          path: Prasuti-Accounts
          token: ${{ env.GH_PAT }}
      
      - name: Checkout Prasuti-Mail
        uses: actions/checkout@v4
        with:
          repository: PrasutiAI/Prasuti-Mail
          path: Prasuti-Mail
          token: ${{ env.GH_PAT }}
      
      - name: Checkout Prasuti-Profiles
        uses: actions/checkout@v4
        with:
          repository: PrasutiAI/Prasuti-Profiles
          path: Prasuti-Profiles
          token: ${{ env.GH_PAT }}
      
      - name: Checkout Prasuti-Mainsite
        uses: actions/checkout@v4
        with:
          repository: PrasutiAI/Prasuti-Mainsite
          path: Prasuti-Mainsite
          token: ${{ env.GH_PAT }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ env.GH_PAT }}
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Verify cluster connection
        run: |
          kubectl get nodes
      
      - name: Deploy all services to UAT
        run: |
          cd Prasuti-KubeNet
          chmod +x deploy-service.sh
          
          # Deploy each service
          ./deploy-service.sh -s services -e uat
          ./deploy-service.sh -s accounts -e uat
          ./deploy-service.sh -s mail -e uat
          ./deploy-service.sh -s profiles -e uat
          ./deploy-service.sh -s www -e uat
      
      - name: Verify deployment
        run: |
          kubectl get pods -n uat
          kubectl get ingress -n uat
